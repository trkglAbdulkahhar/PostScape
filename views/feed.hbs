<div class="container py-4">
    <!-- Search Bar Form -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="input-group shadow-sm rounded-pill overflow-hidden bg-white border border-light">
                <span class="input-group-text bg-white border-0 ps-3">
                    <i class="fas fa-search text-muted small"></i>
                </span>
                <input type="text" id="globalSearch" class="form-control border-0 shadow-none ps-2 py-2"
                    style="font-size: 0.9rem;" placeholder="Search people, posts or tags..." autocomplete="off">
            </div>
        </div>
    </div>

    <!-- Dynamic Search Results Container (Hidden by default) -->
    <div id="searchResults" class="mb-4 d-none">
        <div id="userResultsArea" class="mb-3 d-none">
            <h6 class="fw-bold text-muted ps-1">People</h6>
            <div class="d-flex overflow-auto gap-3 pb-2" id="userResultList" style="scrollbar-width: thin;"></div>
        </div>
        <div id="postResultsArea"></div>
    </div>

    <!-- USERS SEARCH RESULTS (Hybrid Search) -->
    {{#if users}}
    <div class="mb-4">
        <h6 class="fw-bold text-muted mb-3 ps-1">People</h6>
        <div class="d-flex overflow-auto pb-3 gap-3" style="scrollbar-width: thin;">
            {{#each users}}
            <div class="card shadow-sm border-0 flex-shrink-0" style="width: 160px;">
                <div class="card-body text-center p-3">
                    <div class="mb-2">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto shadow-sm"
                            style="width: 48px; height: 48px; font-size: 1.2rem;">
                            {{initials name}}
                        </div>
                    </div>
                    <h6 class="fw-bold mb-0 text-truncate" style="font-size: 0.9rem;">{{name}}</h6>
                    <small class="text-muted d-block mb-2">@{{nickname}}</small>

                    <button
                        class="btn btn-sm w-100 rounded-pill follow-btn-{{this._id}} {{#if (isFollowing ../user._id this.followers)}}btn-outline-secondary{{else}}btn-primary{{/if}}"
                        onclick="followUser('{{this._id}}')">
                        {{#if (isFollowing ../user._id this.followers)}}Unfollow{{else}}Follow{{/if}}
                    </button>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    <!-- Post Grid with ID for easy updates -->
    <div class="row">
        <!-- Main Content (Feed) -->
        <div class="col-lg-12">

            {{!-- <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0 text-muted"><i class="fas fa-globe me-2"></i>Global Feed</h5>
            </div> --}}

            <div class="row row-cols-1 row-cols-md-3 g-4 feed-container" id="postGrid">
                {{#each posts}}
                <div class="col post-card-wrapper" style="animation-delay: {{@index}}00ms">
                    <div class="card h-100 shadow-sm post-card" onclick="goToPost('{{_id}}', '{{slug}}')">
                        {{#if image}}
                        <img src="{{image}}" class="card-img-top" style="height: 250px; object-fit: cover;">
                        {{/if}}
                        <div class="card-body">
                            <h5 class="fw-bold mb-2 card-title">{{title}}</h5>
                            <div class="mb-3 post-tags">
                                {{#each tags}}
                                <span class="badge rounded-pill bg-light text-primary border">@{{this}}</span>
                                {{/each}}
                            </div>
                            <p class="text-muted small mb-0 line-clamp-3">{{body}}</p>
                        </div>
                        <div class="card-footer bg-white border-0 pb-3 d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2 shadow-sm"
                                style="width: 32px; height: 32px; font-size: 0.8rem; font-weight: bold;">
                                {{initials user.name}}
                            </div>
                            <small class="text-dark fw-semibold me-auto">{{user.name}}</small>
                            <div class="d-flex gap-3">
                                <form action="/posts/like/{{this._id}}" method="POST" class="d-inline">
                                    <input type="hidden" name="_csrf" value="{{../csrfToken}}">
                                    <button type="submit"
                                        class="btn btn-link p-0 text-decoration-none 
                                        {{#if (isLikedByUser this.likes ../user._id)}}text-danger{{else}}text-dark{{/if}}">
                                        <i
                                            class="{{#if (isLikedByUser this.likes ../user._id)}}fas text-danger{{else}}far text-dark{{/if}} fa-heart"></i>
                                        <span class="ms-1 small fw-bold">{{this.likes.length}}</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>

            {{#unless posts.length}}
            <div class="text-center py-5">
                <i class="fas fa-images fa-3x text-muted opacity-25 mb-3"></i>
                <h5 class="fw-bold text-muted">No global posts yet.</h5>
            </div>
            {{/unless}}

        </div>
    </div>
</div>

<script>
    // Navigation Logic
    // Navigation Logic
    async function goToPost(postId, slug) {
        fetch(`/posts/track-click/${postId}`, { method: 'POST' }).catch(() => { });
        window.location.href = `/posts/${slug}`;
    }

    // Dynamic Search Logic
    const searchInput = document.getElementById('globalSearch');
    const searchResults = document.getElementById('searchResults');
    const userResultsArea = document.getElementById('userResultsArea');
    const userResultList = document.getElementById('userResultList');
    const postResultsArea = document.getElementById('postResultsArea');
    const defaultFeed = document.querySelector('.feed-container'); // Need to toggle this? Or just prepend?
    // Let's hide default feed when searching

    if (searchInput) {
        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.classList.add('d-none');
                if (defaultFeed) defaultFeed.classList.remove('d-none');
                return;
            }

            if (defaultFeed) defaultFeed.classList.add('d-none');
            searchResults.classList.remove('d-none');

            try {
                const response = await fetch(`/search-api?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                // Render Users
                if (data.users && data.users.length > 0) {
                    userResultsArea.classList.remove('d-none');
                    userResultList.innerHTML = data.users.map(u => `
                        <div class="card shadow-sm border-0 flex-shrink-0" style="width: 140px;">
                            <div class="card-body text-center p-3">
                                <div class="bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    ${u.name.charAt(0)}
                                </div>
                                <h6 class="small fw-bold text-truncate mb-0">${u.name}</h6>
                                <small class="text-muted d-block mb-2 scale-75">@${u.nickname || 'user'}</small>
                                
                                ${u.isFollowing
                            ? `<button onclick="followUser('${u._id}')" class="btn btn-sm btn-outline-secondary rounded-pill py-0" style="font-size: 0.7rem;">Unfollow</button>`
                            : u.isRequested
                                ? `<button onclick="followUser('${u._id}')" class="btn btn-sm btn-warning text-dark rounded-pill py-0" style="font-size: 0.7rem;">Requested</button>`
                                : `<button onclick="followUser('${u._id}')" class="btn btn-sm btn-primary rounded-pill py-0" style="font-size: 0.7rem;">Follow</button>`
                        }
                            </div>
                        </div>
                    `).join('');
                } else {
                    userResultsArea.classList.add('d-none');
                }

                // Render Posts
                if (data.posts && data.posts.length > 0) {
                    postResultsArea.innerHTML = `<div class="row row-cols-1 row-cols-md-3 g-4">` + data.posts.map(p => `
                        <div class="col">
                            <div class="card h-100 shadow-sm post-card" onclick="goToPost('${p._id}', '${p.slug}')">
                                ${p.image ? `<img src="${p.image}" class="card-img-top" style="height: 200px; object-fit: cover;">` : ''}
                                <div class="card-body position-relative">
                                    
                                    <!-- AVATAR IMPLEMENTATION -->
                                    <div class="position-absolute" style="top: 10px; right: 10px; z-index: 10;">
                                         <a href="/user/profile/${p.user._id}" onclick="event.stopPropagation();" 
                                            class="rounded-circle d-block border border-2 border-white shadow-sm overflow-hidden" 
                                            style="width: 32px; height: 32px;">
                                            ${p.user.image
                            ? `<img src="${p.user.image}" style="width: 100%; height: 100%; object-fit: cover;">`
                            : `<div class="bg-primary text-white w-100 h-100 d-flex align-items-center justify-content-center" style="font-size: 0.8rem;">${p.user.name.charAt(0)}</div>`
                        }
                                         </a>
                                    </div>

                                    <h5 class="fw-bold mb-2 card-title pe-4">${p.title}</h5>
                                    <!-- Remove generic 'By' text -->
                                    <p class="text-muted small mb-0 line-clamp-3">${p.body}</p>
                                </div>
                            </div>
                        </div>
                    `).join('') + `</div>`;
                } else {
                    postResultsArea.innerHTML = `<div class="text-center py-5 text-muted">No posts found for "${query}"</div>`;
                }

            } catch (err) {
                console.error("Search error:", err);
            }
        });
    }
</script>

<style>
    /* Feed Animations */
    .feed-container {
        /* display: flex; override grid if needed, but row-cols works well with grid */
        transition: all 0.5s ease-in-out;
    }

    .post-card-wrapper {
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
        /* Star invisible */
        transform: translateY(20px);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .post-card {
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        cursor: pointer;
        border: none;
        overflow: hidden;
    }

    .post-card:hover {
        transform: scale(1.02) translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12) !important;
        z-index: 10;
    }

    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>